//@version=6
indicator("Market Structure Indicator", overlay=true, max_bars_back=5000, max_lines_count=500, max_labels_count=500)

//IMPOSTAZIONI STRUTTURA
colore_rialzista = input.color(color.green, "Colore Rialzista", group="Impostazioni Struttura")
colore_ribassista = input.color(color.red, "Colore Ribassista", group="Impostazioni Struttura")
mostra_etichette = input.bool(true, "Mostra Etichette BOS/CHOC", group="Impostazioni Struttura")
mostra_sfondo = input.bool(true, "Mostra Colore Sfondo", group="Impostazioni Struttura")
mostra_box = input.bool(true, "Mostra Box Stato", group="Impostazioni Struttura")

//RILEVAMENTO PIVOT
pivot_alto = ta.pivothigh(1,1) 
pivot_basso = ta.pivotlow(1,1)

condizione_alto = not na(pivot_alto)
condizione_basso = not na(pivot_basso)

//VARIABILI STRUTTURA
var float massimo = na 
var float minimo = na 
var float massimo_precedente = na 
var float minimo_precedente = na 

var bool uno_basso = true
var bool uno_alto = true 

var int indice_massimo = na 
var int indice_minimo = na 
var int indice_mass = na 
var int indice_mini = na 

var line linea_1 = na 
var line linea_2 = na 
var line linea_3 = na 
var line linea_4 = na 

var bool attiva_1 = false 
var bool attiva_3 = false 

var bool linea_completata_basso = false 
var bool linea_completata_alto = false 
var int contatore = 0 

//CONTATORE BARRE
if barstate.isconfirmed
    contatore := contatore + 1 

condizione_1 = contatore > 10 

//CALCOLI MASSIMI/MINIMI
massimo_periodo = condizione_1 ? ta.highest(bar_index - nz(indice_minimo)) : 1
barra_massimo = condizione_1 ? ta.highestbars(bar_index - nz(indice_minimo)) : 1

minimo_periodo = condizione_1 ? ta.lowest(bar_index - nz(indice_massimo)) : 1
barra_minimo = condizione_1 ? ta.lowestbars(bar_index - nz(indice_massimo)) : 1

//TRACKING TREND
var trend = 0

if ta.crossover(close, massimo) or (ta.crossover(close, massimo_precedente) and linea_completata_basso)
    trend := 1

if ta.crossunder(close, minimo) or (ta.crossunder(close, minimo_precedente) and linea_completata_alto)
    trend := -1

//AGGIORNAMENTO LINEE
if attiva_1  
    line.set_x2(linea_1, bar_index)

if attiva_3
    line.set_x2(linea_3, bar_index)

//STRUTTURA RIALZISTA
if condizione_alto and uno_basso 
    attiva_1 := true 
    uno_basso := false 
    massimo := high[1]
    indice_massimo := bar_index - 1 
    linea_1 := line.new(x1=bar_index - 1, x2=bar_index, y1=high[1], y2=high[1], color=colore_rialzista)

if ta.crossover(close, massimo) 
    attiva_1 := false
    uno_basso := true 
    linea_completata_alto := true 
    minimo_precedente := minimo_periodo
    indice_mass := bar_index + barra_minimo
    linea_2 := line.new(x1=bar_index + barra_minimo, x2=bar_index, y1=minimo_periodo, y2=minimo_periodo, color=colore_ribassista)
    if mostra_etichette
        label.new(int(math.avg(indice_massimo, bar_index)), massimo, 'BOS', color=color(na), textcolor=colore_rialzista, style=label.style_label_down, size=size.tiny)

if ta.crossunder(close, minimo_precedente) and linea_completata_alto 
    linea_completata_alto := false 
    uno_alto := true 
    line.set_x2(linea_2, bar_index)
    if mostra_etichette
        label.new(int(math.avg(indice_mass, bar_index)), minimo_precedente, 'CHOC', color=color(na), textcolor=colore_ribassista, style=label.style_label_up, size=size.tiny)

//STRUTTURA RIBASSISTA
if condizione_basso and uno_alto 
    uno_alto := false 
    attiva_3 := true 
    minimo := low[1]
    indice_minimo := bar_index - 1
    linea_3 := line.new(x1=bar_index - 1, x2=bar_index, y1=low[1], y2=low[1], color=colore_ribassista)

if ta.crossunder(close, minimo) 
    attiva_3 := false
    uno_alto := true 
    massimo_precedente := massimo_periodo
    linea_completata_basso := true 
    indice_mini := bar_index + barra_massimo
    linea_4 := line.new(x1=bar_index + barra_massimo, x2=bar_index, y1=massimo_periodo, y2=massimo_periodo, color=colore_rialzista)
    if mostra_etichette
        label.new(int(math.avg(indice_minimo, bar_index)), minimo, 'BOS', color=color(na), textcolor=colore_ribassista, style=label.style_label_up, size=size.tiny)

if ta.crossover(close, massimo_precedente) and linea_completata_basso
    linea_completata_basso := false 
    uno_basso := true 
    line.set_x2(linea_4, bar_index)
    if mostra_etichette
        label.new(int(math.avg(indice_mini, bar_index)), massimo_precedente, 'CHOC', color=color(na), textcolor=colore_rialzista, style=label.style_label_down, size=size.tiny)

//COLORE SFONDO
bgcolor(mostra_sfondo and trend == 1 ? color.new(colore_rialzista, 90) : mostra_sfondo and trend == -1 ? color.new(colore_ribassista, 90) : na)

// ═══════════════════════════════════════════════════════════════════════════════
// BOX STATO - LOGICA FINALE CORRETTA
// ═══════════════════════════════════════════════════════════════════════════════

// Determina timeframe corrente e codici
nome_timeframe = ""
codice_long_direzionale = ""
codice_long_ritracciamento = ""
codice_short_direzionale = ""
codice_short_ritracciamento = ""

if timeframe.period == "240"
    nome_timeframe := "H4"
    codice_long_direzionale := "A1"
    codice_long_ritracciamento := "A2"
    codice_short_direzionale := "B1"
    codice_short_ritracciamento := "B2"
else if timeframe.period == "60"
    nome_timeframe := "H1"
    codice_long_direzionale := "C1"
    codice_long_ritracciamento := "C2"
    codice_short_direzionale := "D1"
    codice_short_ritracciamento := "D2"
else if timeframe.period == "15"
    nome_timeframe := "M15"
    codice_long_direzionale := "E1"
    codice_long_ritracciamento := "E2"
    codice_short_direzionale := "F1"
    codice_short_ritracciamento := "F2"
else if timeframe.period == "5"
    nome_timeframe := "M5"
    codice_long_direzionale := "G1"
    codice_long_ritracciamento := "G2"
    codice_short_direzionale := "H1"
    codice_short_ritracciamento := "H2"
else
    nome_timeframe := timeframe.period
    codice_long_direzionale := "A1"
    codice_long_ritracciamento := "A2"
    codice_short_direzionale := "B1"
    codice_short_ritracciamento := "B2"

// LOGICA FINALE:
// trend = 1 (background verde) = struttura long
// trend = -1 (background rosso) = struttura short
// massimo = ultimo massimo rotto (linea verde in alto)
// minimo = ultimo minimo rotto (linea rossa in basso)

codice_finale = ""
stato_finale = ""
colore_box = color.gray
spiegazione = ""

prezzo_corrente = close

// STRUTTURA LONG (background verde)
if trend == 1
    if not na(massimo) and prezzo_corrente < massimo
        // Prezzo sotto ultimo massimo NON rotto = RITRACCIAMENTO LONG
        codice_finale := codice_long_ritracciamento
        stato_finale := "long ritracciamento"
        colore_box := color.new(colore_rialzista, 50)
        spiegazione := "background verde + prezzo sotto massimo NON ancora rotto"
    else
        // Prezzo sopra o ha rotto massimo = DIREZIONALE LONG
        codice_finale := codice_long_direzionale
        stato_finale := "long direzionale"
        colore_box := colore_rialzista
        spiegazione := "background verde + prezzo rompe o sopra massimo"

// STRUTTURA SHORT (background rosso)
else if trend == -1
    if not na(minimo) and prezzo_corrente > minimo
        // Prezzo sopra ultimo minimo NON rotto = RITRACCIAMENTO SHORT
        codice_finale := codice_short_ritracciamento
        stato_finale := "short ritracciamento"
        colore_box := color.new(colore_ribassista, 50)
        spiegazione := "background rosso + prezzo sopra minimo NON ancora rotto"
    else
        // Prezzo sotto o ha rotto minimo = DIREZIONALE SHORT
        codice_finale := codice_short_direzionale
        stato_finale := "short direzionale"
        colore_box := colore_ribassista
        spiegazione := "background rosso + prezzo rompe o sotto minimo"

// NEUTRALE
else
    codice_finale := "N/A"
    stato_finale := "neutrale"
    colore_box := color.gray
    spiegazione := "nessun trend attivo"

// Debug dettagliato
testo_background = trend == 1 ? "verde (long)" : trend == -1 ? "rosso (short)" : "neutro"
valore_massimo = not na(massimo) ? str.tostring(massimo, "#.##") : "N/A"
valore_minimo = not na(minimo) ? str.tostring(minimo, "#.##") : "N/A"
valore_prezzo = str.tostring(prezzo_corrente, "#.##")
testo_debug = "background: " + testo_background + " | prezzo: " + valore_prezzo + " | massimo: " + valore_massimo + " | minimo: " + valore_minimo

// BOX
if mostra_box and barstate.islast
    var table tabella = table.new(position.top_right, 2, 5, border_width=2)
    
    // Timeframe
    table.cell(tabella, 0, 0, "timeframe", text_color=color.white, bgcolor=color.gray, text_size=size.small)
    table.cell(tabella, 1, 0, nome_timeframe, text_color=color.white, bgcolor=color.gray, text_size=size.small)
    
    // Stato
    table.cell(tabella, 0, 1, "stato", text_color=color.white, bgcolor=color.gray, text_size=size.small)
    table.cell(tabella, 1, 1, stato_finale, text_color=color.white, bgcolor=colore_box, text_size=size.small)
    
    // Codice
    table.cell(tabella, 0, 2, "codice", text_color=color.white, bgcolor=color.gray, text_size=size.small)
    table.cell(tabella, 1, 2, codice_finale, text_color=color.white, bgcolor=colore_box, text_size=size.large)
    
    // Debug
    table.cell(tabella, 0, 3, "debug", text_color=color.white, bgcolor=color.gray, text_size=size.tiny)
    table.cell(tabella, 1, 3, testo_debug, text_color=color.white, bgcolor=color.new(color.blue, 70), text_size=size.tiny)
    
    // Spiegazione
    table.cell(tabella, 0, 4, "logica", text_color=color.white, bgcolor=color.gray, text_size=size.tiny)
    table.cell(tabella, 1, 4, spiegazione, text_color=color.white, bgcolor=color.new(color.navy, 70), text_size=size.tiny)

//ALERT
alertcondition(ta.crossover(close, massimo) or ta.crossunder(close, minimo), 'alert bos')
alertcondition((ta.crossunder(close, minimo_precedente) and linea_completata_alto) or (ta.crossover(close, massimo_precedente) and linea_completata_basso), 'alert choc')
