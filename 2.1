// ══════════════════════════════════════════════════════════════════════════════
// MARKET STRUCTURE INDICATOR v2.1
// ══════════════════════════════════════════════════════════════════════════════

//@version=6
indicator("Market Structure v3.0", overlay=true, max_bars_back=5000, max_lines_count=500, max_labels_count=500)

// ══════════════════════════════════════════════════════════════════════════════
// COLORI
// ══════════════════════════════════════════════════════════════════════════════

color_bull = color.green
color_bear = color.red

// ══════════════════════════════════════════════════════════════════════════════
// VARIABILI DI STATO
// ══════════════════════════════════════════════════════════════════════════════

var int trend = 0
var bool in_retracement = false

var float bos_level = na
var int bos_level_bar = na
var line bos_line = na
var bool bos_line_active = false

var float choc_level = na
var int choc_level_bar = na
var line choc_line = na
var bool choc_line_active = false

var float last_continuation_level = na
var int last_continuation_bar = na

var float retrace_extreme = na
var int retrace_extreme_bar = na

// ══════════════════════════════════════════════════════════════════════════════
// LOGICA PRINCIPALE
// ══════════════════════════════════════════════════════════════════════════════

if barstate.isconfirmed

    // ==========================================================================
    // INIZIALIZZAZIONE
    // ==========================================================================
    
    if trend == 0
        if close > open
            trend := 1
            last_continuation_level := high
            last_continuation_bar := bar_index
        else
            trend := -1
            last_continuation_level := low
            last_continuation_bar := bar_index
    
    // ==========================================================================
    // TREND SHORT
    // ==========================================================================
    
    else if trend == -1
        
        if not in_retracement
            
            if low < last_continuation_level
                last_continuation_level := low
                last_continuation_bar := bar_index
            else
                in_retracement := true
                bos_level := last_continuation_level
                bos_level_bar := last_continuation_bar
                retrace_extreme := high
                retrace_extreme_bar := bar_index
                
                bos_line := line.new(bos_level_bar, bos_level, bar_index, bos_level, color=color_bear, width=1, style=line.style_solid)
                bos_line_active := true
        
        else
            if high > retrace_extreme
                retrace_extreme := high
                retrace_extreme_bar := bar_index
            
            if bos_line_active
                line.set_x2(bos_line, bar_index)
            if choc_line_active
                line.set_x2(choc_line, bar_index)
            
            // CHECK BOS
            if close < bos_level
                label.new(int(math.avg(bos_level_bar, bar_index)), bos_level, "BOS", color=color(na), textcolor=color_bear, style=label.style_label_up, size=size.tiny)
                
                // TERMINA linea BOS
                if bos_line_active
                    line.set_x2(bos_line, bar_index)
                bos_line_active := false
                
                // TERMINA linea CHOC precedente
                if choc_line_active
                    line.set_x2(choc_line, bar_index)
                choc_line_active := false
                
                // CREA LINEA CHOC (massimo più basso) - MA NON ATTIVA (non verrà estesa)
                choc_level := retrace_extreme
                choc_level_bar := retrace_extreme_bar
                choc_line := line.new(choc_level_bar, choc_level, bar_index, choc_level, color=color_bull, width=1, style=line.style_solid)
                // NON setto choc_line_active := true, così non viene estesa
                
                in_retracement := false
                last_continuation_level := low
                last_continuation_bar := bar_index
                bos_level := na
                bos_level_bar := na
                retrace_extreme := na
                retrace_extreme_bar := na
            
            // CHECK CHOC
            else if not na(choc_level) and close > choc_level
                label.new(int(math.avg(choc_level_bar, bar_index)), choc_level, "CHOC", color=color(na), textcolor=color_bull, style=label.style_label_down, size=size.tiny)
                
                // TERMINA linea CHOC - estendi fino a questa candela
                if choc_line_active
                    line.set_x2(choc_line, bar_index)
                choc_line_active := false
                
                // Se c'era una linea CHOC non attiva, estendila comunque fino a qui
                if not na(choc_line)
                    line.set_x2(choc_line, bar_index)
                
                // TERMINA linea BOS
                if bos_line_active
                    line.set_x2(bos_line, bar_index)
                bos_line_active := false
                
                trend := 1
                in_retracement := false
                last_continuation_level := high
                last_continuation_bar := bar_index
                
                // Nuovo livello CHOC per doppio CHOC
                choc_level := low
                choc_level_bar := bar_index
                choc_line := line.new(bar_index, low, bar_index, low, color=color_bear, width=1, style=line.style_solid)
                choc_line_active := true
                
                bos_level := na
                bos_level_bar := na
                retrace_extreme := na
                retrace_extreme_bar := na
    
    // ==========================================================================
    // TREND LONG
    // ==========================================================================
    
    else if trend == 1
        
        if not in_retracement
            
            if high > last_continuation_level
                last_continuation_level := high
                last_continuation_bar := bar_index
            else
                in_retracement := true
                bos_level := last_continuation_level
                bos_level_bar := last_continuation_bar
                retrace_extreme := low
                retrace_extreme_bar := bar_index
                
                bos_line := line.new(bos_level_bar, bos_level, bar_index, bos_level, color=color_bull, width=1, style=line.style_solid)
                bos_line_active := true
        
        else
            if low < retrace_extreme
                retrace_extreme := low
                retrace_extreme_bar := bar_index
            
            if bos_line_active
                line.set_x2(bos_line, bar_index)
            if choc_line_active
                line.set_x2(choc_line, bar_index)
            
            // CHECK BOS
            if close > bos_level
                label.new(int(math.avg(bos_level_bar, bar_index)), bos_level, "BOS", color=color(na), textcolor=color_bull, style=label.style_label_down, size=size.tiny)
                
                // TERMINA linea BOS
                if bos_line_active
                    line.set_x2(bos_line, bar_index)
                bos_line_active := false
                
                // TERMINA linea CHOC precedente
                if choc_line_active
                    line.set_x2(choc_line, bar_index)
                choc_line_active := false
                
                // CREA LINEA CHOC (minimo più alto) - MA NON ATTIVA (non verrà estesa)
                choc_level := retrace_extreme
                choc_level_bar := retrace_extreme_bar
                choc_line := line.new(choc_level_bar, choc_level, bar_index, choc_level, color=color_bear, width=1, style=line.style_solid)
                // NON setto choc_line_active := true, così non viene estesa
                
                in_retracement := false
                last_continuation_level := high
                last_continuation_bar := bar_index
                bos_level := na
                bos_level_bar := na
                retrace_extreme := na
                retrace_extreme_bar := na
            
            // CHECK CHOC
            else if not na(choc_level) and close < choc_level
                label.new(int(math.avg(choc_level_bar, bar_index)), choc_level, "CHOC", color=color(na), textcolor=color_bear, style=label.style_label_up, size=size.tiny)
                
                // TERMINA linea CHOC - estendi fino a questa candela
                if choc_line_active
                    line.set_x2(choc_line, bar_index)
                choc_line_active := false
                
                // Se c'era una linea CHOC non attiva, estendila comunque fino a qui
                if not na(choc_line)
                    line.set_x2(choc_line, bar_index)
                
                // TERMINA linea BOS
                if bos_line_active
                    line.set_x2(bos_line, bar_index)
                bos_line_active := false
                
                trend := -1
                in_retracement := false
                last_continuation_level := low
                last_continuation_bar := bar_index
                
                // Nuovo livello CHOC per doppio CHOC
                choc_level := high
                choc_level_bar := bar_index
                choc_line := line.new(bar_index, high, bar_index, high, color=color_bull, width=1, style=line.style_solid)
                choc_line_active := true
                
                bos_level := na
                bos_level_bar := na
                retrace_extreme := na
                retrace_extreme_bar := na

// ══════════════════════════════════════════════════════════════════════════════
// BACKGROUND
// ══════════════════════════════════════════════════════════════════════════════

bgcolor(trend == 1 ? color.new(color_bull, 90) : trend == -1 ? color.new(color_bear, 90) : na)

// ══════════════════════════════════════════════════════════════════════════════
// ALERTS
// ══════════════════════════════════════════════════════════════════════════════

alertcondition(trend == -1 and trend[1] == 1, "CHOC Short", "Trend changed to SHORT")
alertcondition(trend == 1 and trend[1] == -1, "CHOC Long", "Trend changed to LONG")
